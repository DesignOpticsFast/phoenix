# Phoenix Sprint 4.4 Chunk 5: Proto File Creation Plan

**Date**: 2025-11-24  
**Chunk**: Sprint 4.4 Chunk 5 - Proto File Creation Plan (Planning Only)  
**Status**: Planning - NO EXECUTION

---

## Executive Summary

This document provides a complete plan for creating the first protobuf file (`capabilities.proto`) in the Palantir repository and integrating it into Phoenix and Bedrock. This is a **planning document only** - no files will be created or modified in this chunk.

**Plan Scope**:
- Directory layout for proto files in Palantir
- Complete Capabilities.proto specification (WP1 minimal)
- Submodule update sequence (Palantir → Phoenix → Bedrock)
- CMake proto codegen integration for both repos
- Contract versioning and tagging strategy
- Risk assessment and open questions

---

## 1. Proposed Directory Layout for Proto Files

### Final Structure in Palantir Repository

```
palantir/
├── proto/                          # New: Protobuf definitions root
│   ├── palantir/                  # Package namespace directory
│   │   ├── capabilities.proto    # WP1: Minimal capabilities message
│   │   ├── compute.proto         # Future: XY Sine, analysis specs
│   │   └── transport.proto       # Future: RPC messages, framing
│   └── README.md                  # Proto documentation (optional)
├── docs/
│   └── data_contracts/            # Existing: Vega-Lite/Arrow contracts (unchanged)
└── README.md                       # Existing: Root README (update to mention proto/)
```

### Rationale

1. **`proto/` root directory**: Clear separation from `docs/` (data contracts) and future code
2. **`proto/palantir/` namespace**: Matches package name, allows future namespaces (e.g., `proto/bedrock/`)
3. **Flat proto files in namespace**: Simple structure for WP1, can organize into subdirectories later if needed
4. **README.md optional**: Can document proto conventions, but not required for WP1

### Consumption Paths

**Phoenix** (after submodule update):
- Proto source: `contracts/proto/palantir/capabilities.proto`
- Generated code: `build/generated/contracts/palantir/capabilities.pb.h`, `.pb.cc`

**Bedrock** (after submodule update):
- Proto source: `docs/palantir/proto/palantir/capabilities.proto`
- Generated code: `build/generated/palantir/capabilities.pb.h`, `.pb.cc`

### Package Namespace

- **Package name**: `palantir`
- **C++ namespace**: `palantir` (generated by protoc)
- **Import path**: `#include "palantir/capabilities.pb.h"`

---

## 2. Final Capabilities.proto Specification (WP1)

### Complete Proto File Draft

```protobuf
// Capabilities.proto
// Palantir transport protocol - Capabilities message
// WP1: Minimal implementation for Phoenix ↔ Bedrock communication

syntax = "proto3";

package palantir;

// CapabilitiesRequest - Request server capabilities
// WP1: Empty message (no filters or parameters)
// Future: May add filters (e.g., feature categories, versions)
message CapabilitiesRequest {
  // Reserved for future use
}

// Capabilities - Server capability information
// WP1: Minimal fields to confirm communication
// Future: Expand with detailed feature lists, version info, etc.
message Capabilities {
  // Server version string (e.g., "bedrock-0.0.1" or "1.2.3")
  string server_version = 1;
  
  // List of supported feature identifiers
  // Examples: "xy_sine", "spot_diagram", "mtf_analysis"
  // WP1: May be empty or contain placeholder
  repeated string supported_features = 2;
}

// CapabilitiesResponse - Response containing server capabilities
message CapabilitiesResponse {
  // Server capabilities
  Capabilities capabilities = 1;
}
```

### Field Rationale

1. **CapabilitiesRequest (empty)**:
   - WP1 goal: Simple request/response to test communication
   - Future: Can add optional filters without breaking compatibility

2. **Capabilities.server_version**:
   - String allows flexible versioning (semantic, date-based, etc.)
   - Useful for debugging and compatibility checks

3. **Capabilities.supported_features**:
   - Repeated string allows extensible feature list
   - WP1: May be empty initially, populated in later sprints
   - Future: Could become structured (feature + version + params)

4. **CapabilitiesResponse**:
   - Wraps Capabilities in response message
   - Allows future addition of metadata (status, errors, etc.)

### Proto3 Considerations

- **Default values**: proto3 uses zero values (empty string, empty repeated)
- **Field numbers**: Start at 1, reserve ranges for future (e.g., 1-10 for WP1, 11-20 for future)
- **Backward compatibility**: Adding new fields is safe, removing or changing field numbers is not

---

## 3. Submodule Update Sequence

### Step-by-Step Execution Plan

#### Phase 1: Create Proto in Palantir

**Location**: `/Users/underlord/workspace/palantir` (or clone if needed)

1. **Clone Palantir repo** (if not already present):
   ```bash
   cd /Users/underlord/workspace
   git clone git@github.com:DesignOpticsFast/palantir.git palantir
   cd palantir
   ```

2. **Create proto directory structure**:
   ```bash
   mkdir -p proto/palantir
   ```

3. **Create capabilities.proto**:
   ```bash
   # Write proto file content (from Section 2 above)
   # File: proto/palantir/capabilities.proto
   ```

4. **Commit to Palantir**:
   ```bash
   git add proto/
   git commit -m "feat(proto): Add Capabilities.proto for WP1 transport reintroduction"
   git push origin main
   ```

5. **Tag release** (optional but recommended):
   ```bash
   git tag -a v1.1.0 -m "Add protobuf Capabilities message"
   git push origin v1.1.0
   ```

6. **Record new commit SHA**:
   ```bash
   NEW_COMMIT=$(git rev-parse HEAD)
   echo "New Palantir commit: $NEW_COMMIT"
   ```

#### Phase 2: Update Phoenix Contracts Submodule

**Location**: `/Users/underlord/workspace/phoenix`

1. **Update contracts submodule to new commit**:
   ```bash
   cd /Users/underlord/workspace/phoenix
   git submodule update --remote contracts
   # Or: git -C contracts checkout <NEW_COMMIT>
   ```

2. **Verify proto file exists**:
   ```bash
   ls -la contracts/proto/palantir/capabilities.proto
   ```

3. **Update .contract-version**:
   ```bash
   echo "<NEW_COMMIT>" > .contract-version
   ```

4. **Stage and commit**:
   ```bash
   git add contracts .contract-version
   git commit -m "chore(contracts): Update to Palantir v1.1.0 with Capabilities.proto"
   ```

#### Phase 3: Update Bedrock Palantir Submodule

**Location**: `/Users/underlord/workspace/bedrock`

1. **Update docs/palantir submodule to new commit**:
   ```bash
   cd /Users/underlord/workspace/bedrock
   git submodule update --remote docs/palantir
   # Or: git -C docs/palantir checkout <NEW_COMMIT>
   ```

2. **Verify proto file exists**:
   ```bash
   ls -la docs/palantir/proto/palantir/capabilities.proto
   ```

3. **Commit submodule update**:
   ```bash
   git add docs/palantir
   git commit -m "chore(palantir): Update submodule to v1.1.0 with Capabilities.proto"
   ```

### Execution Order

**Critical**: Must execute in this order:
1. Palantir first (create proto, commit, push)
2. Phoenix second (update submodule, commit)
3. Bedrock third (update submodule, commit)

**Rationale**: Phoenix and Bedrock depend on Palantir commit existing before they can update submodules.

### Verification Steps

After each phase:
- Verify proto file exists at expected path
- Verify commit SHA matches across repos
- Test protoc can read the proto file (no syntax errors)

---

## 4. CMake Integration Plan

### Phoenix CMake Proto Codegen

**Location**: `CMakeLists.txt` (Phoenix)

**Strategy**: Add proto generation only when `PHX_WITH_TRANSPORT_DEPS=ON`

#### Proposed CMake Code

```cmake
# ---- Palantir protobuf generation (when transport deps enabled) ----
if(PHX_WITH_TRANSPORT_DEPS)
  # Find protoc
  find_program(PROTOC protoc REQUIRED)
  find_program(GRPC_CPP_PLUGIN grpc_cpp_plugin)
  
  # Proto source directory (from contracts submodule)
  set(PALANTIR_PROTO_DIR "${CMAKE_CURRENT_SOURCE_DIR}/contracts/proto")
  set(PALANTIR_GENERATED_DIR "${CMAKE_BINARY_DIR}/generated/contracts")
  
  # Create generated directory
  file(MAKE_DIRECTORY ${PALANTIR_GENERATED_DIR})
  
  # WP1: Only Capabilities proto
  set(CAPABILITIES_PROTO "${PALANTIR_PROTO_DIR}/palantir/capabilities.proto")
  
  if(EXISTS ${CAPABILITIES_PROTO})
    # Generate C++ code from proto
    add_custom_command(
      OUTPUT
        ${PALANTIR_GENERATED_DIR}/palantir/capabilities.pb.h
        ${PALANTIR_GENERATED_DIR}/palantir/capabilities.pb.cc
      COMMAND ${PROTOC}
        --proto_path=${PALANTIR_PROTO_DIR}
        --cpp_out=${PALANTIR_GENERATED_DIR}
        ${CAPABILITIES_PROTO}
      DEPENDS ${CAPABILITIES_PROTO}
      COMMENT "Generating C++ code from capabilities.proto"
    )
    
    # Create proto library target
    add_library(phoenix_palantir_proto STATIC
      ${PALANTIR_GENERATED_DIR}/palantir/capabilities.pb.cc
    )
    
    target_include_directories(phoenix_palantir_proto PUBLIC
      ${PALANTIR_GENERATED_DIR}
    )
    
    # Link protobuf library
    find_package(Protobuf REQUIRED)
    target_link_libraries(phoenix_palantir_proto PUBLIC
      protobuf::libprotobuf
    )
    
    # Add dependency on generated headers
    add_dependencies(phoenix_palantir_proto
      ${PALANTIR_GENERATED_DIR}/palantir/capabilities.pb.h
    )
  else()
    message(WARNING "Capabilities.proto not found at ${CAPABILITIES_PROTO}")
  endif()
endif()
```

**Integration Points**:
- Add `phoenix_palantir_proto` to `phoenix_transport` library (when created in WP1)
- Include generated headers: `#include "palantir/capabilities.pb.h"`

### Bedrock CMake Proto Codegen

**Location**: `CMakeLists.txt` (Bedrock)

**Strategy**: Add proto generation when `BEDROCK_WITH_TRANSPORT_DEPS=ON` (already exists)

#### Proposed CMake Code

```cmake
# ---- Palantir protobuf generation (when transport deps enabled) ----
if(BEDROCK_WITH_TRANSPORT_DEPS)
  # Find protoc
  find_program(PROTOC protoc REQUIRED)
  find_program(GRPC_CPP_PLUGIN grpc_cpp_plugin)
  
  # Proto source directory (from palantir submodule)
  set(PALANTIR_PROTO_DIR "${CMAKE_CURRENT_SOURCE_DIR}/docs/palantir/proto")
  set(PALANTIR_GENERATED_DIR "${CMAKE_BINARY_DIR}/generated/palantir")
  
  # Create generated directory
  file(MAKE_DIRECTORY ${PALANTIR_GENERATED_DIR})
  
  # WP1: Only Capabilities proto
  set(CAPABILITIES_PROTO "${PALANTIR_PROTO_DIR}/palantir/capabilities.proto")
  
  if(EXISTS ${CAPABILITIES_PROTO})
    # Generate C++ code from proto
    add_custom_command(
      OUTPUT
        ${PALANTIR_GENERATED_DIR}/palantir/capabilities.pb.h
        ${PALANTIR_GENERATED_DIR}/palantir/capabilities.pb.cc
      COMMAND ${PROTOC}
        --proto_path=${PALANTIR_PROTO_DIR}
        --cpp_out=${PALANTIR_GENERATED_DIR}
        ${CAPABILITIES_PROTO}
      DEPENDS ${CAPABILITIES_PROTO}
      COMMENT "Generating C++ code from capabilities.proto"
    )
    
    # Add to existing bedrock library or create new target
    # Option A: Add to existing bedrock_engine or bedrock_plugin
    # Option B: Create bedrock_palantir_proto library
    
    # For WP1, add to existing target (e.g., bedrock_plugin)
    list(APPEND BEDROCK_PLUGIN_SOURCES
      ${PALANTIR_GENERATED_DIR}/palantir/capabilities.pb.cc
    )
    
    target_include_directories(bedrock_plugin PUBLIC
      ${PALANTIR_GENERATED_DIR}
    )
    
    # Link protobuf library
    find_package(Protobuf REQUIRED)
    target_link_libraries(bedrock_plugin PUBLIC
      protobuf::libprotobuf
    )
  else()
    message(WARNING "Capabilities.proto not found at ${CAPABILITIES_PROTO}")
  endif()
endif()
```

**Integration Points**:
- Add generated sources to existing Bedrock library (e.g., `bedrock_plugin`)
- Include generated headers: `#include "palantir/capabilities.pb.h"`

### Build Flag Isolation

**Phoenix**:
- `PHX_WITH_TRANSPORT_DEPS=OFF`: No proto generation, no protobuf dependencies
- `PHX_WITH_TRANSPORT_DEPS=ON`: Proto generation enabled, protobuf required

**Bedrock**:
- `BEDROCK_WITH_TRANSPORT_DEPS=OFF`: No proto generation (if this option exists)
- `BEDROCK_WITH_TRANSPORT_DEPS=ON`: Proto generation enabled

**Verification**:
- Test build with flag OFF: Should succeed without proto/protobuf
- Test build with flag ON: Should generate proto code and link protobuf

---

## 5. Contract Versioning Plan

### Versioning Strategy

**Palantir Repository**:
- **Current version**: v1.0.0 (initial commit, docs only)
- **Proposed version**: v1.1.0 (first proto addition)
- **Tagging**: Semantic versioning (major.minor.patch)
  - Major: Breaking changes to contract structure
  - Minor: New proto files or non-breaking additions
  - Patch: Bug fixes or documentation updates

**Phoenix `.contract-version`**:
- **Current**: `ad0e9882cd3d9cbbf80fc3b4ac23cd1df7547f53` (v1.0.0)
- **After update**: `<NEW_COMMIT_SHA>` (v1.1.0)
- **Format**: Full commit SHA (40 characters)
- **Update trigger**: When Palantir submodule is updated

### Update Process

1. **Palantir**: Create proto, commit, tag v1.1.0
2. **Phoenix**: Update submodule to new commit, update `.contract-version` to new SHA
3. **Bedrock**: Update submodule to same commit (no `.contract-version` file needed)

### Version Parity Enforcement

**Requirement**: Phoenix and Bedrock must use the same Palantir commit for proto parity.

**Verification**:
- Compare `git -C contracts rev-parse HEAD` (Phoenix)
- Compare `git -C docs/palantir rev-parse HEAD` (Bedrock)
- Should match exactly

**CI Enforcement** (future):
- Add CI check to verify Phoenix and Bedrock submodule commits match
- Fail build if mismatch detected

### Future Versioning Considerations

- **Proto evolution**: Use proto3 field addition rules (add new fields, don't remove)
- **Breaking changes**: Require major version bump and coordination
- **Multiple proto files**: Version each file independently or version repo as whole?
  - **Recommendation**: Version repo as whole (simpler, ensures consistency)

---

## 6. Risks and Open Questions

### Identified Risks

1. **Proto file not found after submodule update**:
   - **Risk**: Submodule update fails or points to wrong commit
   - **Mitigation**: Verify proto file exists after each submodule update
   - **Detection**: CMake warning if proto file missing

2. **CMake proto generation fails**:
   - **Risk**: protoc not found or proto syntax error
   - **Mitigation**: Test proto file with protoc manually before CMake integration
   - **Detection**: CMake configure will fail if protoc missing

3. **Submodule commit mismatch**:
   - **Risk**: Phoenix and Bedrock use different Palantir commits
   - **Mitigation**: Update both submodules to same commit in same session
   - **Detection**: Manual verification or future CI check

4. **Build flag isolation breaks**:
   - **Risk**: Proto code leaks into non-transport builds
   - **Mitigation**: Test builds with flag OFF and ON
   - **Detection**: Build failures or linker errors

### Open Questions

1. **Should bedrock_server use Capabilities.proto?**
   - **Question**: Should bedrock_server implement Capabilities RPC endpoint?
   - **Recommendation**: Defer to WP2+ (WP1 only needs proto file existence)
   - **Impact**: Low (doesn't block WP1)

2. **Should XY Sine proto be created in WP1?**
   - **Question**: Create `compute.proto` with XY Sine message now?
   - **Recommendation**: No - WP1 is Capabilities-only per scope
   - **Impact**: None (deferred to WP2)

3. **Should Palantir use proto3 default values?**
   - **Question**: Rely on proto3 zero-value defaults or require explicit values?
   - **Recommendation**: Use proto3 defaults (simpler, standard practice)
   - **Impact**: Low (proto3 standard behavior)

4. **Should all future IPC live in same folder or multiple namespaces?**
   - **Question**: `proto/palantir/` for all, or `proto/palantir/`, `proto/bedrock/`, etc.?
   - **Recommendation**: Keep all in `proto/palantir/` for now, split later if needed
   - **Impact**: Low (can refactor later)

5. **Should proto files be pre-generated and committed?**
   - **Question**: Generate during build or commit generated files?
   - **Recommendation**: Generate during build (cleaner, no generated file conflicts)
   - **Impact**: Medium (affects build time, but standard practice)

6. **Should Bedrock have `.contract-version` file?**
   - **Question**: Mirror Phoenix's `.contract-version` in Bedrock?
   - **Recommendation**: Optional - submodule commit is sufficient
   - **Impact**: Low (nice-to-have for consistency)

### Decisions Needed Before Chunk 6

**Critical** (must decide):
- None - plan is complete and ready for execution

**Optional** (can defer):
- Whether to tag Palantir v1.1.0 immediately or wait
- Whether to add proto README.md in Palantir
- Whether Bedrock should have `.contract-version` file

---

## 7. Summary

### Plan Completeness

✅ **Directory layout**: Defined (`proto/palantir/capabilities.proto`)  
✅ **Proto specification**: Complete draft ready for implementation  
✅ **Submodule update sequence**: Step-by-step plan defined  
✅ **CMake integration**: Proposed code for both Phoenix and Bedrock  
✅ **Versioning strategy**: Clear tagging and `.contract-version` update plan  
✅ **Risks identified**: Mitigation strategies defined  
✅ **Open questions**: Documented with recommendations

### Ready for Execution

**Chunk 6 Prerequisites**:
- [x] Plan approved
- [ ] Access to Palantir repository (clone or existing)
- [x] Protobuf toolchain installed (from Chunk 3)
- [x] Git submodule understanding confirmed

**Chunk 6 Execution**:
1. Create `proto/palantir/capabilities.proto` in Palantir
2. Commit and push to Palantir main
3. Tag Palantir v1.1.0 (optional)
4. Update Phoenix contracts submodule
5. Update Phoenix `.contract-version`
6. Update Bedrock docs/palantir submodule
7. Verify proto files exist in both repos
8. Test protoc can read proto file

**Next Steps After Chunk 6**:
- Integrate CMake proto generation (Chunk 7 or WP1)
- Create minimal transport client using Capabilities.proto (WP1)
- Test proto code generation in both repos

---

**End of Proto File Creation Plan**

**Status**: ✅ **READY FOR CHUNK 6 EXECUTION**

